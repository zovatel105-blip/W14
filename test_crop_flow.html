<!DOCTYPE html>
<html>
<head>
    <title>Test Crop Flow</title>
</head>
<body>
    <h1>Test Crop Data Flow</h1>
    <div id="results"></div>
    
    <script>
    async function testCropFlow() {
        const results = document.getElementById('results');
        
        try {
            // 1. Test creating a poll with transform data
            console.log('üß™ Testing crop data flow...');
            
            const testPollData = {
                title: "Test Transform Poll",
                options: [
                    {
                        text: "Test Option",
                        media_type: "image",
                        media_url: "https://picsum.photos/400/300",
                        media_transform: {
                            position: { x: 25, y: 75 },
                            scale: 1.3
                        }
                    }
                ]
            };
            
            console.log('üì§ Sending poll data:', testPollData);
            
            // Create poll
            const createResponse = await fetch('/api/polls', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer test' // You'll need a real token
                },
                body: JSON.stringify(testPollData)
            });
            
            if (!createResponse.ok) {
                throw new Error(`Create failed: ${createResponse.status}`);
            }
            
            const createdPoll = await createResponse.json();
            console.log('‚úÖ Poll created:', createdPoll);
            
            // 2. Fetch polls to see if transform data is returned
            const fetchResponse = await fetch('/api/polls');
            const polls = await fetchResponse.json();
            
            console.log('üì• Fetched polls:', polls);
            
            // Find our test poll
            const testPoll = polls.find(p => p.title === "Test Transform Poll");
            if (testPoll) {
                console.log('üîç Test poll found:', testPoll);
                
                const option = testPoll.options[0];
                console.log('üîç Option media:', option.media);
                
                if (option.media && option.media.transform) {
                    console.log('‚úÖ Transform data preserved:', option.media.transform);
                    results.innerHTML = `
                        <h2>‚úÖ SUCCESS</h2>
                        <p>Transform data found in poll:</p>
                        <pre>${JSON.stringify(option.media.transform, null, 2)}</pre>
                    `;
                } else {
                    console.log('‚ùå Transform data missing');
                    results.innerHTML = `
                        <h2>‚ùå FAILED</h2>
                        <p>Transform data not found in poll option</p>
                        <p>Option media: ${JSON.stringify(option.media, null, 2)}</p>
                    `;
                }
            } else {
                console.log('‚ùå Test poll not found');
                results.innerHTML = `
                    <h2>‚ùå FAILED</h2>
                    <p>Test poll not found in response</p>
                `;
            }
            
        } catch (error) {
            console.error('‚ùå Test failed:', error);
            results.innerHTML = `
                <h2>‚ùå ERROR</h2>
                <p>Test failed: ${error.message}</p>
            `;
        }
    }
    
    // Run test
    testCropFlow();
    </script>
</body>
</html>